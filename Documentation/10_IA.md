# Sistema de Inteligencia Artificial

## Visión General

El sistema de IA usa árboles de comportamiento (Behavior Trees) para definir la lógica de decisión de los enemigos de forma modular y extensible.

```
CerebroIA
    │
    └── raiz (NodoIA)
            │
            ├── Selector (prueba opciones hasta que una funcione)
            │       ├── Secuencia: "Curar si vida baja"
            │       │       ├── Condicion: VidaBaja
            │       │       └── Accion: UsarCuracion
            │       │
            │       └── Secuencia: "Atacar enemigo"
            │               └── Accion: AtacarObjetivo
```

---

## Arquitectura

### Jerarquía de Clases

```
NodoIA (abstracta)
    │
    ├── Condicion
    │       ├── CondicionVidaBaja
    │       ├── CondicionEnemigoDebil
    │       └── CondicionTieneMana
    │
    ├── Accion
    │       ├── AccionAtacar
    │       ├── AccionCurar
    │       └── AccionDefender
    │
    ├── Secuencia
    │       └── Ejecuta hijos en orden, falla si uno falla
    │
    └── Selector
            └── Prueba hijos hasta que uno tenga éxito
```

---

## Clases Base

### NodoIA (Abstracta)

**Archivo**: `Assets/Scripts/IA/SistemaIA.cs`

```csharp
public abstract class NodoIA
{
    // Ejecutar la lógica del nodo
    // Retorna: true = éxito, false = fallo
    public abstract bool Ejecutar(ContextoIA contexto);
}
```

### ContextoIA

```csharp
public class ContextoIA
{
    public Enemigos Yo { get; set; }          // La entidad que decide
    public Entidad[] Enemigos { get; set; }   // Objetivos hostiles (jugadores)
    public Entidad[] Aliados { get; set; }    // Otros enemigos
    public Entidad ObjetivoActual { get; set; }
}
```

---

## Nodos de Control

### Secuencia

Ejecuta hijos en orden. **Falla si cualquier hijo falla**.

```csharp
public class Secuencia : NodoIA
{
    private List<NodoIA> hijos = new List<NodoIA>();
    
    public void AgregarHijo(NodoIA nodo)
    {
        hijos.Add(nodo);
    }
    
    public override bool Ejecutar(ContextoIA contexto)
    {
        foreach (var hijo in hijos)
        {
            if (!hijo.Ejecutar(contexto))
                return false;  // Falla toda la secuencia
        }
        return true;  // Todos tuvieron éxito
    }
}
```

**Ejemplo de uso**:
```
Secuencia: "Curar aliado herido"
    1. Condicion: ¿Hay aliado con vida baja? → Si falla, aborta
    2. Accion: Seleccionar aliado herido
    3. Accion: Usar habilidad de curación
```

### Selector

Prueba hijos en orden. **Tiene éxito si cualquier hijo tiene éxito**.

```csharp
public class Selector : NodoIA
{
    private List<NodoIA> hijos = new List<NodoIA>();
    
    public void AgregarHijo(NodoIA nodo)
    {
        hijos.Add(nodo);
    }
    
    public override bool Ejecutar(ContextoIA contexto)
    {
        foreach (var hijo in hijos)
        {
            if (hijo.Ejecutar(contexto))
                return true;  // Encontró uno que funciona
        }
        return false;  // Ninguno funcionó
    }
}
```

**Ejemplo de uso**:
```
Selector: "Decidir acción"
    1. Secuencia: Curar si vida < 20% → Si funciona, termina
    2. Secuencia: Usar habilidad especial → Si funciona, termina
    3. Accion: Atacar → Fallback
```

---

## Nodos de Condición

### CondicionVidaBaja

```csharp
public class CondicionVidaBaja : NodoIA
{
    private float umbral;  // Ej: 0.3 = 30%
    
    public CondicionVidaBaja(float umbral)
    {
        this.umbral = umbral;
    }
    
    public override bool Ejecutar(ContextoIA contexto)
    {
        float porcentaje = (float)contexto.Yo.Stats.VidaActual / 
                          contexto.Yo.Stats.VidaMaxima;
        return porcentaje < umbral;
    }
}
```

### CondicionEnemigoDebil

```csharp
public class CondicionEnemigoDebil : NodoIA
{
    private float umbral;
    
    public CondicionEnemigoDebil(float umbral)
    {
        this.umbral = umbral;
    }
    
    public override bool Ejecutar(ContextoIA contexto)
    {
        foreach (var enemigo in contexto.Enemigos)
        {
            float porcentaje = (float)enemigo.Stats.VidaActual / 
                              enemigo.Stats.VidaMaxima;
            if (porcentaje < umbral)
            {
                contexto.ObjetivoActual = enemigo;
                return true;
            }
        }
        return false;
    }
}
```

### CondicionTieneMana

```csharp
public class CondicionTieneMana : NodoIA
{
    private int cantidadRequerida;
    
    public CondicionTieneMana(int cantidad)
    {
        this.cantidadRequerida = cantidad;
    }
    
    public override bool Ejecutar(ContextoIA contexto)
    {
        // Implementar si tienes sistema de maná
        return contexto.Yo.Stats.ManaActual >= cantidadRequerida;
    }
}
```

---

## Nodos de Acción

### AccionAtacar

```csharp
public class AccionAtacar : NodoIA
{
    public override bool Ejecutar(ContextoIA contexto)
    {
        // Si no hay objetivo, seleccionar uno
        if (contexto.ObjetivoActual == null && contexto.Enemigos.Length > 0)
        {
            contexto.ObjetivoActual = contexto.Enemigos[0];
        }
        
        if (contexto.ObjetivoActual == null)
            return false;
        
        // Usar ataque básico
        var habilidad = contexto.Yo.ObtenerHabilidadBasica();
        if (habilidad != null)
        {
            habilidad.Ejecutar(contexto.Yo, contexto.ObjetivoActual);
            return true;
        }
        
        return false;
    }
}
```

### AccionCurar

```csharp
public class AccionCurar : NodoIA
{
    public override bool Ejecutar(ContextoIA contexto)
    {
        var habilidadCura = contexto.Yo.ObtenerHabilidadDeTipo(TipoHabilidad.Curacion);
        
        if (habilidadCura == null)
            return false;
        
        // Curarse a sí mismo
        habilidadCura.Ejecutar(contexto.Yo, contexto.Yo);
        return true;
    }
}
```

### AccionSeleccionarObjetivoMasDébil

```csharp
public class AccionSeleccionarObjetivoMasDebil : NodoIA
{
    public override bool Ejecutar(ContextoIA contexto)
    {
        Entidad masDebil = null;
        float menorVida = float.MaxValue;
        
        foreach (var enemigo in contexto.Enemigos)
        {
            float porcentaje = (float)enemigo.Stats.VidaActual / 
                              enemigo.Stats.VidaMaxima;
            if (porcentaje < menorVida)
            {
                menorVida = porcentaje;
                masDebil = enemigo;
            }
        }
        
        if (masDebil != null)
        {
            contexto.ObjetivoActual = masDebil;
            return true;
        }
        
        return false;
    }
}
```

---

## CerebroIA

**Archivo**: `Assets/Scripts/IA/SistemaIA.cs`

```csharp
public class CerebroIA
{
    private NodoIA raiz;
    
    public CerebroIA(NodoIA raiz)
    {
        this.raiz = raiz;
    }
    
    public void Decidir(ContextoIA contexto)
    {
        raiz.Ejecutar(contexto);
    }
}
```

---

## Configurar IA en Enemigos

### En la clase Enemigos

```csharp
public class Enemigos : Entidad
{
    protected CerebroIA cerebro;
    
    public virtual void InicializarIA()
    {
        // IA básica por defecto
        var selector = new Selector();
        
        // Opción 1: Curar si vida baja
        var secuenciaCurar = new Secuencia();
        secuenciaCurar.AgregarHijo(new CondicionVidaBaja(0.3f));
        secuenciaCurar.AgregarHijo(new AccionCurar());
        selector.AgregarHijo(secuenciaCurar);
        
        // Opción 2: Atacar al más débil
        var secuenciaAtacar = new Secuencia();
        secuenciaAtacar.AgregarHijo(new AccionSeleccionarObjetivoMasDebil());
        secuenciaAtacar.AgregarHijo(new AccionAtacar());
        selector.AgregarHijo(secuenciaAtacar);
        
        // Fallback: Atacar a cualquiera
        selector.AgregarHijo(new AccionAtacar());
        
        cerebro = new CerebroIA(selector);
    }
    
    public void EjecutarTurnoIA(Entidad[] jugadores, Entidad[] aliados)
    {
        var contexto = new ContextoIA
        {
            Yo = this,
            Enemigos = jugadores,
            Aliados = aliados
        };
        
        cerebro.Decidir(contexto);
    }
}
```

---

## Ejemplos de Árboles de Comportamiento

### Goblin (Cobarde)

```csharp
public class Goblin : Enemigos
{
    public override void InicializarIA()
    {
        var selector = new Selector();
        
        // Si vida < 50%, huir/defender
        var secuenciaHuir = new Secuencia();
        secuenciaHuir.AgregarHijo(new CondicionVidaBaja(0.5f));
        secuenciaHuir.AgregarHijo(new AccionDefender());
        selector.AgregarHijo(secuenciaHuir);
        
        // Atacar al más débil
        var secuenciaAtacar = new Secuencia();
        secuenciaAtacar.AgregarHijo(new AccionSeleccionarObjetivoMasDebil());
        secuenciaAtacar.AgregarHijo(new AccionAtacar());
        selector.AgregarHijo(secuenciaAtacar);
        
        cerebro = new CerebroIA(selector);
    }
}
```

### Dragon (Agresivo)

```csharp
public class Dragon : Enemigos
{
    public override void InicializarIA()
    {
        var selector = new Selector();
        
        // Si tiene maná, usar aliento de fuego
        var secuenciaEspecial = new Secuencia();
        secuenciaEspecial.AgregarHijo(new CondicionTieneMana(50));
        secuenciaEspecial.AgregarHijo(new AccionUsarHabilidadEspecial("AlientoFuego"));
        selector.AgregarHijo(secuenciaEspecial);
        
        // Siempre atacar al objetivo con más vida
        var secuenciaAtacar = new Secuencia();
        secuenciaAtacar.AgregarHijo(new AccionSeleccionarObjetivoMasVida());
        secuenciaAtacar.AgregarHijo(new AccionAtacar());
        selector.AgregarHijo(secuenciaAtacar);
        
        cerebro = new CerebroIA(selector);
    }
}
```

### Orco Chamán (Soporte)

```csharp
public class OrcoChamán : Enemigos
{
    public override void InicializarIA()
    {
        var selector = new Selector();
        
        // Prioridad 1: Curar aliado con vida baja
        var secuenciaCurarAliado = new Secuencia();
        secuenciaCurarAliado.AgregarHijo(new CondicionAliadoVidaBaja(0.3f));
        secuenciaCurarAliado.AgregarHijo(new AccionCurarAliado());
        selector.AgregarHijo(secuenciaCurarAliado);
        
        // Prioridad 2: Buff aliados
        var secuenciaBuff = new Secuencia();
        secuenciaBuff.AgregarHijo(new CondicionTieneMana(30));
        secuenciaBuff.AgregarHijo(new AccionBuffAliados());
        selector.AgregarHijo(secuenciaBuff);
        
        // Fallback: Atacar
        selector.AgregarHijo(new AccionAtacar());
        
        cerebro = new CerebroIA(selector);
    }
}
```

---

## Diagrama Visual

```
         ┌─────────────────────────────────────────┐
         │              Selector                   │
         └─────────────────────────────────────────┘
                           │
         ┌─────────────────┼─────────────────┐
         │                 │                 │
         ▼                 ▼                 ▼
    ┌─────────┐      ┌─────────┐      ┌─────────┐
    │Secuencia│      │Secuencia│      │ Accion  │
    │ Curar   │      │ Atacar  │      │ Atacar  │
    └─────────┘      └─────────┘      │(fallback)│
         │                 │          └─────────┘
    ┌────┴────┐      ┌────┴────┐
    ▼         ▼      ▼         ▼
┌───────┐ ┌──────┐ ┌───────┐ ┌──────┐
│Cond.  │ │Accion│ │Accion │ │Accion│
│VidaBaja│ │Curar │ │Select │ │Atacar│
└───────┘ └──────┘ │Target │ └──────┘
                   └───────┘
```

---

## Integración con Combate

```csharp
// En CombateManager
private void EjecutarTurnoEnemigo(Enemigos enemigo)
{
    // Verificar si puede actuar
    if (enemigo.GestorEstados.EstaIncapacitado)
    {
        Debug.Log(enemigo.Nombre + " está incapacitado!");
        return;
    }
    
    // Obtener lista de jugadores y aliados
    var jugadores = ObtenerJugadoresVivos();
    var aliados = ObtenerEnemigosVivos().Where(e => e != enemigo).ToArray();
    
    // Ejecutar IA
    enemigo.EjecutarTurnoIA(jugadores, aliados);
}
```

---

## Extensibilidad

Para agregar nuevo comportamiento:

1. **Nueva Condición**: Heredar de `NodoIA`, implementar `Ejecutar()`
2. **Nueva Acción**: Heredar de `NodoIA`, implementar `Ejecutar()`
3. **Combinar** en el método `InicializarIA()` del enemigo

```csharp
// Ejemplo: Condición "enemigo tiene estado"
public class CondicionEnemigoTieneEstado : NodoIA
{
    private StatusFlag estado;
    
    public CondicionEnemigoTieneEstado(StatusFlag estado)
    {
        this.estado = estado;
    }
    
    public override bool Ejecutar(ContextoIA contexto)
    {
        foreach (var enemigo in contexto.Enemigos)
        {
            if (enemigo.TieneEstado(estado))
            {
                contexto.ObjetivoActual = enemigo;
                return true;
            }
        }
        return false;
    }
}
```
